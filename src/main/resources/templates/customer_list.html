<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>
    <link rel="shortcut icon" type="image/png" href="/images/logos/osangjaiellogo.png"/>
    <link rel="stylesheet" href="/libs/simplebar/dist/simplebar.min.css">
    <link rel="stylesheet" href="/css/styles.min.css"/>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<!--  Body Wrapper -->
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
     data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar" include-html="/templates/left-panel.html"></aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
        <!--  Header Start -->
        <header class="app-header">
            <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item d-block d-xl-none">
                        <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                            <i class="ti ti-bell-ringing"></i>
                            <div class="notification bg-primary rounded-circle"></div>
                        </a>
                    </li>
                </ul>
                <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                    <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <img src="/images/profile/user-1.jpg" alt="" width="35" height="35"
                                     class="rounded-circle">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                                 aria-labelledby="drop2">
                                <div class="message-body">
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-userDTO fs-6"></i>
                                        <p class="mb-0 fs-3">My Profile</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-mail fs-6"></i>
                                        <p class="mb-0 fs-3">My Account</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-list-check fs-6"></i>
                                        <p class="mb-0 fs-3">My Task</p>
                                    </a>
                                    <a href="./authentication-login.html"
                                       class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
        <!--  Header End -->

        <!-- Content Start -->
        <div class="container-fluid">
            <div class="content-container">
                <button class="register-button" id="registerButton"><b>+</b> New</button>
                <button class="delete-button" id="deleteButton" disabled><b>-</b> Delete</button>
                <table id="customerTable" class="customer-table display" style="width:100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>고객사 명</th>
                        <th>정보</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
        <!-- Content End -->

        <!-- 등록 모달 창 Start -->
        <div class="customer-modal" id="customer-modal">
            <div class="customer-modal-content">
                <div class="customer-modal-header">고객사 등록</div>
                <div class="customer-modal-body">
                    <form id="customerForm">
                        <label for="name">고객사</label>
                        <input type="text" id="name" name="name" required>

                        <label for="editor">고객사 정보</label>
                        <div id="editor"></div>
                    </form>
                </div>
                <div class="customer-modal-footer">
                    <button class="close-btn" id="closeModal">취소</button>
                    <button class="submit-btn" id="submitCustomer">등록</button>
                </div>
            </div>
        </div>
        <!-- 등록 모달 창 End -->

        <!-- 알림 팝업 Start -->
        <div class="info-modal" id="infoModal">
            <div class="info-modal-content">
                <p class="info-message" id="infoMessage"></p>
                <button class="info-close-btn" id="closeInfoBtn">확인</button>
            </div>
        </div>
        <!-- 알림 팝업 End -->

        <!-- 오류 팝업 Start -->
        <div class="error-modal" id="errorModal">
            <div class="error-modal-content">
                <p class="error-message" id="errorMessage">알 수 없는 오류가 발생했습니다.</p>
                <button class="error-close-btn" id="closeErrorBtn">닫기</button>
            </div>
        </div>
        <!-- 오류 팝업 End -->

    </div>
</div>

<script>
    let customerTable = null;

    function initCustomerTable() {
        fetch('/customer/view', {
            method: 'GET'
            }
        )
            .then(response => response.json())
            .then(data => {
                customerTable = $('#customerTable').DataTable({
                    data: data,
                    columnDefs: [
                        {
                            orderable: false,
                            render: DataTable.render.select(),
                            targets: 0
                        },
                        {targets: 1, className: "customer-name"},
                        {targets: 2, className: "customer-information"}
                    ],
                    columns: [
                        {"data": null},
                        {"data": "name"},
                        {"data": "information"}
                    ],
                    processing: true,
                    select: {
                        style: 'single',
                        selector: 'td:first-child'
                    },
                    responsive: true
                });
            })
            .then(() => {
                $(".markdown-body").each(function () {
                    new toastui.Editor.factory({
                        el: this,
                        height: 'auto',
                        viewer: true,
                        initialValue: this.innerHTML
                    });
                });
            })
            .then(() => {
                customerTable.on('select', function (e, dt, type, indexes) {
                    $('#deleteButton').attr('disabled', false);
                });

                customerTable.on('deselect', function (e, dt, type, indexes) {
                    $('#deleteButton').attr('disabled', true);
                });
            })
            .catch(error => {
                console.error(error);
            });
    }

    $(document).ready(function () {
        initCustomerTable();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('customer-modal');
        const infoModal = document.getElementById('infoModal');
        const infoMessage = document.getElementById('infoMessage');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const openRegisterButton = document.getElementById('registerButton');
        const closeModalButton = document.getElementById('closeModal');
        const closeInfoButton = document.getElementById('closeInfoBtn');
        const closeErrorButton = document.getElementById('closeErrorBtn');
        const submitButton = document.getElementById('submitCustomer');
        const deleteButton = document.getElementById('deleteButton');

        const editor = new toastui.Editor({
            el: document.querySelector('#editor'), // 에디터를 적용할 요소 (컨테이너)
            height: '400px',                        // 에디터 영역의 높이 값 (OOOpx || auto)
            initialEditType: 'markdown',            // 최초로 보여줄 에디터 타입 (markdown || wysiwyg)
            initialValue: '',                       // 내용의 초기 값으로, 반드시 마크다운 문자열 형태여야 함
            previewStyle: 'vertical'                // 마크다운 프리뷰 스타일 (tab || vertical)
        });

        // 모달 열기
        openRegisterButton.addEventListener('click', function () {
            modal.style.display = 'block';
        });

        // 모달 닫기
        closeModalButton.addEventListener('click', function () {
            modal.style.display = 'none';
            editor.setMarkdown('');
        });

        // 오류 팝업 닫기
        closeErrorButton.addEventListener('click', function () {
            errorModal.style.display = 'none';
        });

        closeInfoButton.addEventListener('click', function () {
            infoModal.style.display = 'none';
        });

        // 고객사 등록 버튼 클릭 (Ajax 요청)
        submitButton.addEventListener('click', function () {
            const customerData = {
                name: document.getElementById('name').value,
                information: editor.getMarkdown(),
            };

            // Ajax 요청
            fetch('/customer/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                },
                body: new URLSearchParams(customerData),
            })
                .then(response => response.text())
                .then(result => {
                    if (result === '0') {
                        infoMessage.textContent = '고객사가 성공적으로 등록되었습니다.';
                        infoModal.style.display = 'block';
                        modal.style.display = 'none'; // 모달 닫기
                        document.getElementById('customerForm').reset(); // 폼 초기화
                        editor.setMarkdown('');
                        customerTable.destroy();
                        initCustomerTable();
                    } else if (result === '2') {
                        errorMessage.textContent = '중복된 고객사 이름이 있습니다. 다시 시도해주세요.';
                        errorModal.style.display = 'block';
                    } else {
                        errorMessage.textContent = '추가 중 알 수 없는 오류가 발생했습니다. 다시 시도해주세요.';
                        errorModal.style.display = 'block';
                    }
                })
                .catch(error => {
                    errorMessage.textContent = '추가 중 서버 오류가 발생했습니다.';
                    errorModal.style.display = 'block';
                    console.error(error);
                });
        });

        // 삭제 버튼
        deleteButton.addEventListener('click', function () {
            console.log(customerTable.row().data());
            // Ajax 요청
            fetch('/customer/del', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8',
                },
                body: JSON.stringify(customerTable.row().data()),
            })
                .then(response => response.text())
                .then(result => {
                    if (result === '0') {
                        infoMessage.textContent = '고객사가 성공적으로 삭제되었습니다.';
                        infoModal.style.display = 'block';
                        customerTable.destroy();
                        initCustomerTable();
                    } else {
                        errorMessage.textContent = '삭제 중 알 수 없는 오류가 발생했습니다. 다시 시도해주세요.';
                        errorModal.style.display = 'block';
                    }
                })
                .catch(error => {
                    errorMessage.textContent = '삭제 중 서버 오류가 발생했습니다.';
                    errorModal.style.display = 'block';
                    console.error(error);
                });
        });
    });
</script>

<script src="/libs/jquery/dist/jquery.min.js"></script>
<script src="/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="/libs/simplebar/dist/simplebar.js"></script>
<script src="/js/sidebarmenu.js"></script>
<script src="/js/app.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
<!--  toastui  -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
<!--  datatables  -->
<link href="/css/datatables/datatables.css" rel="stylesheet">
<script src="/js/datatables/datatables.js"></script>
<!--  Custom Style  -->
<link rel="stylesheet" href="/css/popup.css"/>

<script>
    includeLeftPanel();
</script>
</body>

</html>