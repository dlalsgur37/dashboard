<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>
    <link rel="shortcut icon" type="image/png" href="/images/logos/osangjaiellogo.png"/>
    <link rel="stylesheet" href="/libs/simplebar/dist/simplebar.min.css">
    <link rel="stylesheet" href="/css/styles.min.css"/>
    <link rel="stylesheet" href="/css/popup.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
</head>

<body>
<!--  Body Wrapper -->
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
     data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar" include-html="/templates/left-panel.html"></aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
        <!--  Header Start -->
        <header class="app-header">
            <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item d-block d-xl-none">
                        <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                            <i class="ti ti-bell-ringing"></i>
                            <div class="notification bg-primary rounded-circle"></div>
                        </a>
                    </li>
                </ul>
                <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                    <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <img src="/images/profile/user-1.jpg" alt="" width="35" height="35"
                                     class="rounded-circle">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                                 aria-labelledby="drop2">
                                <div class="message-body">
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-userDTO fs-6"></i>
                                        <p class="mb-0 fs-3">My Profile</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-mail fs-6"></i>
                                        <p class="mb-0 fs-3">My Account</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-list-check fs-6"></i>
                                        <p class="mb-0 fs-3">My Task</p>
                                    </a>
                                    <a href="./authentication-login.html"
                                       class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
        <!--  Header End -->
        <div class="container-fluid">
            <div class="content-container">
                <button class="register-button" id="openModal"> + New</button>
            </div>
        </div>

        <!-- 등록 모달 창 -->
        <div class="customer-modal" id="customer-modal">
            <div class="customer-modal-content">
                <div class="customer-modal-header">고객사 등록</div>
                <div class="customer-modal-body">
                    <form id="customerForm">
                        <label for="name">고객사</label>
                        <input type="text" id="name" name="name" required>

                        <label for="editor">고객사 정보</label>
                        <div id="editor"></div>
                    </form>
                </div>
                <div class="customer-modal-footer">
                    <button class="close-btn" id="closeModal">취소</button>
                    <button class="submit-btn" id="submitCustomer">등록</button>
                </div>
            </div>
        </div>
        <!-- 등록 모달 창 End -->

        <!-- 오류 팝업 -->
        <div class="error-modal" id="errorModal">
            <div class="error-modal-content">
                <p class="error-message" id="errorMessage">알 수 없는 오류가 발생했습니다.</p>
                <button class="error-close-btn" id="closeErrorBtn">닫기</button>
            </div>
        </div>
        <!-- 오류 팝업 End -->

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('customer-modal');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const openModalButton = document.getElementById('openModal');
        const closeModalButton = document.getElementById('closeModal');
        const closeErrorButton = document.getElementById('closeErrorBtn');
        const submitButton = document.getElementById('submitCustomer');

        const editor = new toastui.Editor({
            el: document.querySelector('#editor'), // 에디터를 적용할 요소 (컨테이너)
            height: '400px',                        // 에디터 영역의 높이 값 (OOOpx || auto)
            initialEditType: 'markdown',            // 최초로 보여줄 에디터 타입 (markdown || wysiwyg)
            initialValue: '',                       // 내용의 초기 값으로, 반드시 마크다운 문자열 형태여야 함
            previewStyle: 'vertical'                // 마크다운 프리뷰 스타일 (tab || vertical)
        });

        // 모달 열기
        openModalButton.addEventListener('click', function () {
            modal.style.display = 'block';
        });

        // 모달 닫기
        closeModalButton.addEventListener('click', function () {
            modal.style.display = 'none';
            editor.setMarkdown('');
        });

        // 오류 팝업 닫기
        closeErrorButton.addEventListener('click', function () {
            errorModal.style.display = 'none';
        });

        // 고객사 등록 버튼 클릭 (Ajax 요청)
        submitButton.addEventListener('click', function () {
            const customerData = {
                name: document.getElementById('name').value,
                information: editor.getMarkdown(),
            };

            // Ajax 요청
            fetch('/customer/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                },
                body: new URLSearchParams(customerData),
            })
                .then(response => response.text())
                .then(result => {
                    if (result === '1') {
                        alert('고객사가 성공적으로 등록되었습니다.');
                        modal.style.display = 'none'; // 모달 닫기
                        document.getElementById('customerForm').reset(); // 폼 초기화
                        editor.setMarkdown('')
                    } else if (result === '0') {
                        errorMessage.textContent = '중복된 고객사 이름이 있습니다. 다시 시도해주세요.';
                        errorModal.style.display = 'block';
                    } else {
                        errorMessage.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
                        errorModal.style.display = 'block';
                    }
                })
                .catch(error => {
                    errorMessage.textContent = '서버 오류가 발생했습니다.';
                    errorModal.style.display = 'block';
                    console.error(error);
                });
        });
    });
</script>

<script src="/libs/jquery/dist/jquery.min.js"></script>
<script src="/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="/libs/simplebar/dist/simplebar.js"></script>
<script src="/js/sidebarmenu.js"></script>
<script src="/js/app.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
<script>
    includeLeftPanel();
</script>
</body>

</html>